pipeline {
  agent any
  environment {
    VENV = 'venv'
    PY = 'python'          // or 'py -3' if you prefer
    PIP = 'pip'
  }
  stages {
    stage('Setup') {
      steps {
        bat """
          if not exist %VENV% %PY% -m venv %VENV%
          %VENV%\\Scripts\\%PIP% install --upgrade pip
          %VENV%\\Scripts\\%PIP% install -r requirements.txt
        """
      }
    }

    stage('Lint') {
      steps {
        // call flake8 via python -m to avoid activate quirks
        bat "%VENV%\\Scripts\\%PY% -m flake8 app.py"
      }
    }

    stage('Test') {
      steps {
        bat "%VENV%\\Scripts\\%PY% -m pytest -q"
      }
    }

    stage('Coverage') {
      steps {
        bat """
          %VENV%\\Scripts\\%PY% -m coverage erase
          %VENV%\\Scripts\\%PY% -m coverage run -m pytest -q
          %VENV%\\Scripts\\%PY% -m coverage report -m
          %VENV%\\Scripts\\%PY% -m coverage xml -o coverage.xml
        """
        archiveArtifacts artifacts: 'coverage.xml', fingerprint: true
      }
    }

    stage('Security Scan') {
      steps {
        bat """
          %VENV%\\Scripts\\%PY% -m bandit -r . -f json -o bandit.json
          type bandit.json
        """
        archiveArtifacts artifacts: 'bandit.json', fingerprint: true
      }
    }

    stage('Deploy') {
      steps {
        // Simple local "deploy": package artifact (zip) to simulate release
        bat """
          if exist dist rmdir /s /q dist
          mkdir dist
          copy app.py dist\\
          %VENV%\\Scripts\\%PY% -m pip freeze > dist\\requirements.lock.txt
          powershell -NoProfile -Command "Compress-Archive -Path dist\\* -DestinationPath artifact.zip -Force"
        """
        archiveArtifacts artifacts: 'artifact.zip', fingerprint: true
        echo "Deployment artifact archived."
      }
    }
  }
  post {
    always { cleanWs() }
  }
}
